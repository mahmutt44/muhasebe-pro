{% extends "base.html" %}

{% block title %}{{ t.products }} - {{ t.app_name }}{% endblock %}

{% block content %}
<!-- Başlık -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1">
            <span style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                {{ t.products }}
            </span>
        </h2>
        <p class="text-secondary mb-0">{{ t.products }}</p>
    </div>
    <button onclick="showAddModal()" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1"></i>{{ t.new_product }}
    </button>
</div>

<!-- İstatistik Kartları -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card" style="border-left: 4px solid #667eea;">
            <div class="card-body text-center py-3">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px; background: var(--primary-gradient);">
                    <i class="bi bi-box-seam text-white"></i>
                </div>
                <h4 class="fw-bold mb-0" style="color: #667eea;">{{ products|length }}</h4>
                <small class="text-secondary">{{ t.total_products }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card" style="border-left: 4px solid #38ef7d;">
            <div class="card-body text-center py-3">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px; background: var(--success-gradient);">
                    <i class="bi bi-currency-lira text-white"></i>
                </div>
                <h4 class="fw-bold mb-0 text-success">₺{{ "%.2f"|format((products|sum(attribute='unit_price') / products|length) if products else 0) }}</h4>
                <small class="text-secondary">{{ t.average_price }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card" style="border-left: 4px solid #00f2fe;">
            <div class="card-body text-center py-3">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px; background: var(--info-gradient);">
                    <i class="bi bi-tags text-white"></i>
                </div>
                <h4 class="fw-bold mb-0 text-info">{{ products|map(attribute='unit')|unique|list|length }}</h4>
                <small class="text-secondary">{{ t.unit }}</small>
            </div>
        </div>
    </div>
</div>

<!-- Ürün Listesi -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; background: var(--primary-gradient);">
                <i class="bi bi-list-ul text-white"></i>
            </div>
            <h6 class="mb-0 fw-semibold">{{ t.product_list }}</h6>
        </div>
        <div class="input-group input-group-sm" style="width: 220px;">
            <span class="input-group-text bg-transparent border-secondary">
                <i class="bi bi-search text-secondary"></i>
            </span>
            <input type="text" id="searchInput" class="form-control border-secondary" placeholder="{{ t.search_product }}">
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>{{ t.product_name }}</th>
                        <th class="text-center hide-mobile">{{ t.unit }}</th>
                        <th class="text-end">{{ t.unit_price }}</th>
                        <th class="text-center hide-mobile">{{ t.date }}</th>
                        <th class="text-center">{{ t.actions }}</th>
                    </tr>
                </thead>
                <tbody id="productsList">
                    {% for product in products %}
                    <tr class="product-row">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle d-flex align-items-center justify-content-center me-2 d-none d-sm-flex" style="width: 36px; height: 36px; background: var(--info-gradient);">
                                    <i class="bi bi-box text-white"></i>
                                </div>
                                <div>
                                    <span class="fw-semibold">{{ product.name }}</span>
                                </div>
                            </div>
                        </td>
                        <td class="text-center hide-mobile">
                            <span class="badge" style="background: var(--info-gradient);">{{ product.unit }}</span>
                        </td>
                        <td class="text-end">
                            <span class="fw-bold" style="color: #667eea;">₺{{ "%.2f"|format(product.unit_price) }}</span>
                            <small class="text-secondary">/{{ product.unit }}</small>
                        </td>
                        <td class="text-center hide-mobile">
                            <small class="text-secondary">{{ product.created_at|format_date }}</small>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button onclick="editProduct({{ product.id }})" class="btn btn-outline-warning" title="Düzenle">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button onclick="deleteProduct({{ product.id }})" class="btn btn-outline-danger" title="Sil">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <i class="bi bi-box fs-1 text-secondary d-block mb-2"></i>
                            <span class="text-secondary">{{ t.no_data }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ürün Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitle">{{ t.new_product }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="productForm">
                <div class="modal-body">
                    <input type="hidden" name="id" id="productId">
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">{{ t.product_name }} *</label>
                        <input type="text" name="name" id="productName" required class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">{{ t.unit }} *</label>
                        <select name="unit" id="productUnit" required class="form-select">
                            <option value="">{{ t.all }}...</option>
                            <option value="adet">Adet</option>
                            <option value="kg">Kg</option>
                            <option value="gram">Gram</option>
                            <option value="litre">Litre</option>
                            <option value="paket">Paket</option>
                            <option value="kutu">Kutu</option>
                            <option value="fincan">Fincan</option>
                            <option value="pet">Pet</option>
                            <option value="şişe">Şişe</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">{{ t.unit_price }} (₺) *</label>
                        <input type="number" name="unit_price" id="productPrice" step="0.01" min="0" required class="form-control">
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ t.cancel }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>{{ t.save }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const modal = new bootstrap.Modal(document.getElementById('productModal'));

function showAddModal() {
    document.getElementById('modalTitle').textContent = '{{ t.new_product }}';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    modal.show();
}

function editProduct(id) {
    apiCall(`/api/products/${id}`)
        .then(p => {
            document.getElementById('modalTitle').textContent = '{{ t.edit_product }}';
            document.getElementById('productId').value = p.id;
            document.getElementById('productName').value = p.name;
            document.getElementById('productUnit').value = p.unit;
            document.getElementById('productPrice').value = p.unit_price;
            modal.show();
        })
        .catch(err => showNotification(err.message, 'error'));
}

function deleteProduct(id) {
    // Modal oluştur
    const modalHtml = `
        <div class="modal fade show" id="deleteModal" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-sm">
                <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                    <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                        <h6 class="modal-title text-light">{{ t.delete_product if t.delete_product else 'Ürünü Sil' }}</h6>
                        <button type="button" class="btn-close btn-close-white" onclick="closeDeleteModal()"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-warning small mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            {{ t.confirm_delete_product if t.confirm_delete_product else 'Bu ürünü silmek istediğinizden emin misiniz?' }}
                        </p>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="closeDeleteModal()">{{ t.cancel if t.cancel else 'İptal' }}</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete(${id})">{{ t.delete if t.delete else 'Sil' }}</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    if (modal) modal.remove();
}

function confirmDelete(id) {
    closeDeleteModal();
    apiCall(`/api/products/${id}`, { method: 'DELETE' })
        .then(() => {
            showNotification('{{ t.product_deleted }}', 'success');
            location.reload();
        })
        .catch(err => showNotification(err.message, 'error'));
}

document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('productId').value;
    const data = {
        name: document.getElementById('productName').value,
        unit: document.getElementById('productUnit').value,
        unit_price: parseFloat(document.getElementById('productPrice').value)
    };
    
    try {
        if (id) {
            await apiCall(`/api/products/${id}`, { method: 'PUT', body: JSON.stringify(data) });
            showNotification('{{ t.product_updated }}', 'success');
        } else {
            await apiCall('/api/products', { method: 'POST', body: JSON.stringify(data) });
            showNotification('{{ t.product_added }}', 'success');
        }
        modal.hide();
        location.reload();
    } catch (err) {
        showNotification(err.message, 'error');
    }
});

// Arama
document.getElementById('searchInput').addEventListener('input', function() {
    const search = this.value.toLowerCase();
    document.querySelectorAll('.product-row').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
    });
});
</script>
{% endblock %}
